<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video chat</title>
</head>

<body>
    <h1 id="username-label">Username</h1>
    <input id="input-username" type="text" placeholder="tyep username">
    <button id="subtn-username">Join</button><br>
    <div id="video-container">
        <video style="border: solid;" id="local_video" autoplay playsinline ></video><br>

    </div>
    <!-- <video style="border: solid;" id="remote_video" autoplay ></video> -->
    <button id="mute-btn";">mute/unmute</button>


    <script>
        let usernameInput = document.querySelector("#input-username");
        let joinBtn = document.querySelector("#subtn-username");
        let ws;
        let mapPeers = {};
        
        function webSocketOnMessage(event){
            let parsedData = JSON.parse(event.data);
            let peerUsername = parsedData["peer"];
            let action = parsedData["action"];

            let receiver_channel_name = parsedData["message"]["receiver_channel_name"]

            if(action == "new-peer"){
                createOfferer(peerUsername, receiver_channel_name);
                return;
            }

            if(action == "new-offer"){
                let offer = parsedData["message"]["sdp"];

                createAnswerer(offer, peerUsername, receiver_channel_name);

                return;
            }
            if (action == "new-answer"){
                let answer = parsedData["message"]["sdp"];  

                let peer = mapPeers[peerUsername][0];
                peer.setRemoteDescription(answer).then(() => console.log("remote description set successfully"));
                return;
            }

        }

        joinBtn.addEventListener('click', () =>{
            let username = usernameInput.value;
            
            console.log("username: ", username);
            
            if(usernameInput == "") return;
            
            usernameInput.value = "";
            usernameInput.disabled = true;
            usernameInput.style.visibility = "hidden";

            joinBtn.disabled = true;
            joinBtn.style.visibility = "hidden";
            
            let usernameLabel = document.getElementById("username-label");
            usernameLabel.innerHTML = username;

            let loc = window.location;
            let wsStart = "ws://";

            if(loc.protocol =="https:") wsStart = "wss://";

            let endpoint = wsStart + loc.host + "/ws/vc/";
            
            console.log("endpoint", endpoint);

            ws = new WebSocket(endpoint);

            ws.addEventListener('open', e => {
                console.log("connection opened!");
                sendSignal("new-peer", {});
            } );
            ws.addEventListener('message', webSocketOnMessage);
            ws.addEventListener('close', e => {
                console.log("connection closed!");
            });
            ws.addEventListener('error', e => {
                console.log("error occured!");
            });

            
        })

        let localStream = new MediaStream();

        const constraints = {
            "audio" : true,
            "video" : true
        };

        let localVideo = document.querySelector("#local_video");
        let mutebtn = document.querySelector("#mute-btn");

        let userMedia = navigator.mediaDevices.getUserMedia(constraints).then(stream => {
            localStream = stream;
            localVideo.srcObject = localStream;
            localVideo.muted = true;

            let audioTracks = stream.getAudioTracks();

            audioTracks[0].enabled = true;

            mutebtn.addEventListener('click', () => {
                audioTracks[0].enabled = !audioTracks[0].enabled;
            });

        })
        .catch(e => {
            console.error("error accessing media devices: ", e);
        });

        function sendSignal(action, message){
            let jsonStr = JSON.stringify({
                "peer": usernameInput,
                "action": action,
                "message": message
            });
            ws.send(jsonStr);
        }

        function createOfferer(peerUsername, receiver_channel_name){
            const configuration = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]};
            let peer = new RTCPeerConnection(configuration);

            addLocalTracks(peer);

            let dc = peer.createDataChannel('channel');
            dc.addEventListener('open', () =>{
                console.log("data channel is opened!");
            });

            let remoteVideo = createVideo(peerUsername);
            setOnTrack(peer, remoteVideo);

            mapPeers[peerUsername] = [peer, dc];

            peer.addEventListener("iceconnectionstatechange", () => {
                let iceConnectionState = peer.iceConnectionState;
                if(iceConnectionState === "failed" || iceConnectionState === "disconnected" || iceConnectionState === "closed"){
                    delete mapPeers[peerUsername];

                    if(iceConnectionState != "closed") peer.close();

                    removeVideo(remoteVideo);
                }
            });

            peer.addEventListener("icecandidate", event => {
                if(event.candidate){
                    console.log("new ice candidate!");
                    return;
                }
                sendSignal("new-offer", {
                    'sdp': peer.localDescription,
                    'receiver_channel_name': receiver_channel_name
                });
            });

            peer.createOffer().then(o => {
                peer.setLocalDescription(o);
            }).then(() => {
                console.log("local description set succesfully.");
            });
        }

        function createAnswerer(offer, peerUsername, receiver_channel_name){
            const configuration = {'iceServers': [{'urls': 'stun:stun.l.google.com:19302'}]};
            let peer = new RTCPeerConnection(configuration);

            addLocalTracks(peer);

            
            let remoteVideo = createVideo(peerUsername);
            setOnTrack(peer, remoteVideo);
            
            peer.addEventListener("datachannel", e =>{
                peer.dc = e.channel;
                peer.dc.addEventListener('open', () =>{
                    console.log("data channel is opened!");
                });
                mapPeers[peerUsername] = [peer, peer.dc];
            });


            peer.addEventListener("iceconnectionstatechange", () => {
                let iceConnectionState = peer.iceConnectionState;
                if(iceConnectionState === "failed" || iceConnectionState === "disconnected" || iceConnectionState === "closed"){
                    delete mapPeers[peerUsername];

                    if(iceConnectionState != "closed") peer.close();

                    removeVideo(remoteVideo);
                }
            });

            peer.addEventListener("icecandidate", event => {
                if(event.candidate){
                    console.log("new ice candidate!");
                    return;
                }
                sendSignal("new-answer", {
                    'sdp': peer.localDescription,
                    'receiver_channel_name': receiver_channel_name
                });
            });

            peer.setRemoteDescription(offer).then(() => {
                console.log("remote description set successfully for %s", peerUsername);
                return peer.createAnswer();
            }).then(a => {
                console.log("answer created.");
                peer.setLocalDescription(a).then(() => console.log("local description set successfully."));
            });
        }

        function addLocalTracks(peer){
            localStream.getTracks().forEach(track => {
                peer.addTrack(track, localStream);
            });
            return;
        }

        function createVideo(peerUsername){
            let remoteVideo = document.createElement("video");

            remoteVideo.id = peerUsername + "-video";
            remoteVideo.autoplay = true;
            remoteVideo.playsInline = true;

            let video_container = document.querySelector("#video-container");
            video_container.appendChild(remoteVideo);

            return remoteVideo;
        }

        function setOnTrack(peer, remoteVideo){
            let remoteStream = new MediaStream();

            remoteVideo.srcObject = remoteStream;

            peer.addEventListener('track', async (event) => {
                remoteStream.addTrack(event.track, remoteStream);
            });
        }

        function removeVideo(remoteVideo){
            let parent_div = remoteVideo.parentNode;
            
            parent_div.removeChild(remoteVideo);
        }

    </script>
</body>

</html>